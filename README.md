# Тестовое задание для практикума SimbirSoft

## Взаимодействие с программой
Исполняемый скрипт - main.py, взаимодействие с которым происходит через параметры запуска (Пример строки запуска: `python main.py create_tables`). Существует 4 команды - `create_tables`, `add_new_url --url --source --name --extension`, `all_files`, `delete_url --id --url --table_name`: 
* `add_new_url` используется для добавления в таблицу информации о новом источнике данных, расположенному по пути из параметра `--url`; Параметр `--name` служит для указания названия создаваемой таблицы, а `--extension` - для указания на тип файла. `--source` используется для идентификации источника: на данный момент поддерживаются: 
  + Ссылки напрямую до файлов (get запрос к ним возвращает источник данных), для этого данный параметр можно не указывать.
  + Ссылки на файл в mail cloud (для этого указывать параметр `--source="mail"`).
* `create_tables` используется для обработки (парсинг, определения типа столбцов по заполнению, выявление первичного ключа и т.д.) данных из таблицы source (читать об архитектуре) и последующего представления их в виде таблиц в базе данных. Создаются все таблицы, которые все еще не были созданы, и заполняются данными из соответствующих файлов.
* `all_files` выводит таблицу с информацией о текущем состоянии таблицы `source` (то есть все обратабываемые источники данных, которые будут использоваться при вызове `create_tables`).
* `delete_url` используется для удаления запииси из таблицы `source` и для удаления соответствующей таблицы (если она была создана). Принимает `url`, `table_name`, `id` (получить можно из `all_files`), при этом достаточно всего одного параметра и хотя бы один является необходимым (без параметров будет выброшено окно помощи `ArgumentParser`)

На данный момент поддерживаются форматы: CSV, JSON. 
Требования к форматам:
* `CSV` - любой формат таблиц, единственное условие - в столбцах должны быть записаны лишь поддерживаемые типа данных.
* `JSON` - файлы этого формата должны отвечать следующей структуре: `{primary_key_1: {}, primary_key_2: {}, ...}`: уровень вложенности не больше 2-х, при этом ключи для второго уровня являются первичными в создаваемой таблице.

Типы данных PostgreSQL, корректно обрабатываемые программой: `BOOLEAN`, `INTEGER`, `BIGINT`, `DECIMAL`, `TIMESTAMP` (даты должны записываться в таком же виде, как они и храняться в PostgresSQL), `VARCHAR`. Указание других в источнике данных может привести к непредвиденному поведению программы.

## Архитектура
Есть всего одна по умолчанию инициализируемая таблица в базе данных - `source`, которая в себе хранит всю информацию про конкретный источник данных, который указывается через `add_new_url`. Данные из этой таблицы используются для создания таблиц через `create_tables`.

Конфигурация для подключаемой базы данных задается или через переменные окружения (`DB_NAME`, `DB_HOST`, `DB_USER`, `DB_PASS`, `DB_PORT`) или в `.env` файле в корне программы (указывать там аналогичные параметры).

Запуск контейнеров с приложением и базой данных происходит с помощью `docker-compose`, но перед этим необходимо собрать образ `simbir_test`: `docker build -t simbir_test .` (вместо . указывать относительный или абсолютный путь до `Dockerfile` из репозитория). Далее `compose` файл нужно собрать с помощью `docker-compose build`, а потом запустить в фоновом режиме с помощью `docker compose up -d`. Далее нужно зайти в контейнер с помощью `docker exec -it data_db_worker bash` и запустить консольное приложение с помощью `python main.py` в соответствии с используемыми командами (смотреть п. "Взаимодействие с программой"). Далее контейнеры можно остановить в ручную с помощью `docker stop` или оба разом с помощью `docker compose down`.
## Некоторые подробности о работе приложения
Определение первичного ключа работает так: ищется первый столбец, в котором все значения уникальные и нет `NULL` значений. Если тип данных этого столбца - `INTEGER`, то при создании таблицы этому полю выставляется тип `SERIAL`, иначе заданный тип.
Определение типов полей происходит по указанным в них значениям.

Вся журнилизация о работе приложения происходит в `logs/all_logs.log` с указанием соответствующего уровня и времени с помощью `logging` (при необходимости можно стандартными методами просмотреть логи с помощью `docker logs`), при этом сообщения о статусе / результате выполнения команд также пишутся в клиентскую консоль в соответствующем формате.

## Демонстрация работы приложения
### Добавление нового источника
![изображение](https://github.com/user-attachments/assets/37207dc6-a9c8-4636-9f38-b1dca15adf26)

### Состояние из таблицы `source` после этого
![изображение](https://github.com/user-attachments/assets/8415a242-3f7e-412b-acd4-113d7212abf6)

### Создание всех таблиц из `source`
![изображение](https://github.com/user-attachments/assets/b6338d0a-5dde-440a-946a-b4945202bea6)

### Добавленная таблица со всеми данными, установленным pk, нужным названием
![изображение](https://github.com/user-attachments/assets/069f83e6-d0f5-43b5-89d7-0ed373764dac)

### Добавление нового источника (невозможно добавить источник, название таблицы для которого уже есть в `source`)
![изображение](https://github.com/user-attachments/assets/d57c7bfc-a8f9-4b73-a228-353097b68000)

### Создание всех имеющихся в `source` таблиц
![изображение](https://github.com/user-attachments/assets/f17e7042-8f03-47a6-9b32-4dac9be73627)

### Добавление новой таблицы из источника с расширением `.json`
![изображение](https://github.com/user-attachments/assets/26af821a-8c7c-4e37-997a-f5220a9fa713)

### Удаление записи по id
![изображение](https://github.com/user-attachments/assets/773a8c93-a0a0-4fe6-a116-8c474d949429)

### Отсутствие соответствующей таблицы после удаления
![изображение](https://github.com/user-attachments/assets/ffb55bec-3755-4b64-8ec3-7dc685e83036)

### Состояние файла с логами после всех операций
![изображение](https://github.com/user-attachments/assets/dbf191ae-2a6e-4a41-a02c-c0bc974d2336)
